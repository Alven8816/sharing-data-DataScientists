---
title: "ÍøÒ³ÅÅÃûËã·¨ (Pagerank Algorithm)·ÖÎö½ðÖÝÓÂÊ¿¶ÓÔ±ÅÅÃû¼°´«ÇòÂ·Ïß"
author: "ÓàÎÄ»ª"
date: "2016Äê4ÔÂ10ÈÕ"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ÎÄÇ°ÕªÒª

    Í¨¹ý±¾ÆªÎÄÕÂ£¬Äã½«Ñ§Ï°µ½£º
    
1. ÍøÒ³ÅÅÃûËã·¨ (Pagerank Algorithm)µÄ¼òÒª¸ÅÊö

2. ÔËÓÃPagerankËã·¨ÊµÏÖNBA½ðÖÝÓÂÊ¿¶Ó´«ÇòÂ·Ïß¼°ÇòÔ±µÄÖØÒª³Ì¶È·ÖÎö

3. Í¨¹ýRÖÐµÄnetworkD3°üÊµÏÖ¿É½»»¥µÄD3ÖÆÍ¼

    
##PagerankËã·¨¸ÅÊö
    
    ËµÆðPagerankËã·¨£¬²»µÃ²»ÌáÆð¹È¸èËÑË÷£¬¿ÉÒÔËµÊÇpagerank³É¾ÍÁËGoogle£¬Ò²¿ÉÒÔËµGoogle³É¾ÍÁËPagerankËã·¨¡£PagerankÊÇÒ»ÖÖÓÉ ¾ÝÍøÒ³Ö®¼äÏà»¥µÄ³¬Á´½Ó¼ÆËãµÄ¼¼Êõ£¬ÒÔGoogle¹«Ë¾´´°ìÈËÀ­Àï¡¤ÅåÆæ£¨Larry Page£©Ö®ÐÕÀ´ÃüÃû¡£
    
> PageRank ÊÇ»ùÓÚ¡¸´ÓÐí¶àÓÅÖÊµÄÍøÒ³Á´½Ó¹ýÀ´µÄÍøÒ³£¬±Ø¶¨»¹ÊÇÓÅÖÊÍøÒ³¡¹µÄ»Ø¹é¹ØÏµ£¬À´ÅÐ¶¨ËùÓÐÍøÒ³µÄÖØÒªÐÔ¡£

    PageRankµÄ¼ÆËã»ùÓÚÒÔÏÂÁ½¸ö»ù±¾¼ÙÉè£º

* ÊýÁ¿¼ÙÉè£ºÈç¹ûÒ»¸öÒ³Ãæ½Úµã½ÓÊÕµ½µÄÆäËûÍøÒ³Ö¸ÏòµÄÈëÁ´ÊýÁ¿Ô½¶à£¬ÄÇÃ´Õâ¸öÒ³ÃæÔ½ÖØÒª
* ÖÊÁ¿¼ÙÉè£ºÖ¸ÏòÒ³ÃæAµÄÈëÁ´ÖÊÁ¿²»Í¬£¬ÖÊÁ¿¸ßµÄÒ³Ãæ»áÍ¨¹ýÁ´½ÓÏòÆäËûÒ³Ãæ´«µÝ¸ü¶àµÄÈ¨ÖØ¡£ËùÒÔÔ½ÊÇÖÊÁ¿¸ßµÄÒ³ÃæÖ¸ÏòÒ³ÃæA£¬ÔòÒ³ÃæAÔ½ÖØÒª¡£
    
> ¼ÆËã¹«Ê½£º

* PR(pi): piÒ³ÃæµÄPageRankÖµ
* n: ËùÓÐÒ³ÃæµÄÊýÁ¿
* pi: ²»Í¬µÄÍøÒ³p1,p2,p3
* M(i): piÁ´ÈëÍøÒ³µÄ¼¯ºÏ
* L(j): pjÁ´³öÍøÒ³µÄÊýÁ¿
* d:×èÄáÏµÊý, ÈÎÒâÊ±¿Ì£¬ÓÃ»§µ½´ïÄ³Ò³Ãæºó²¢¼ÌÐøÏòºóä¯ÀÀµÄ¸ÅÂÊ¡£
* (1-d=0.15) :±íÊ¾ÓÃ»§Í£Ö¹µã»÷£¬Ëæ»úÌøµ½ÐÂURLµÄ¸ÅÂÊÈ¡Öµ·¶Î§: 0 < d ¡Ü 1, GoogleÉèÎª0.85

##ÊµÏÖNBA½ðÖÝÓÂÊ¿¶Ó´«ÇòÂ·Ïß¼°ÇòÔ±µÄÖØÒª³Ì¶È·ÖÎö

###¶ÁÈ¡Êý¾Ý

    Êý¾ÝÀ´Ô´ÓÚYUKI KATOHµÄ²©¿Í¼°Æägithub£¬ÔÚÆä²©¿ÍÖÐËµÃ÷ÁËÊý¾ÝÀ´Ô´£º

> µ÷ÓÃAPI£¬´ÓNBA.comÖÐplayerdashptpass µÄ¶Ëµã²¢ÇÒ½«Í¬¶ÓËùÓÐÇòÔ±Êý¾Ý±£´æµ½±¾µØµÄ JSON ÎÄ¼þÖÐ¡£Êý¾ÝÀ´×Ô 2015-16Èü¼¾µÄ´«Çò¼ÇÂ¼¡£

    ±¾ÎÄÖ±½Ó¶ÁÈ¡ÒÑ¾­×¥È¡Êý¾Ý£¨±ÊÕß³¢ÊÔ×¥È¡²¢ÏîÍ¨¹ýrlist°ü°ÑjsonÇåÏ´ÎªÀíÏëµÄÊý¾Ý¼¯£¬»¹ÉÐÎ´³É¹¦£¬Ö»ºÃÏÈÄÃÆä½á¹¹»¯Êý¾ÝÒ»ÊÔ£©¡£

```{r}
#½ðÖÝÓÂÊ¿¶ÓÔ±´«ÇòÊý¾Ý
passes <- read.csv("passes.csv",header = TRUE,stringsAsFactors = TRUE)
#½ðÖÝÓÂÊ¿15¸ö¶ÓÔ±Î»ÖÃÐÅÏ¢
groups <- read.csv("groups.csv",header = TRUE,stringsAsFactors = FALSE)
head(passes)
head(groups)
```
   
###PagerankËã·¨ÊµÏÖ 

1. ¹¹ÔìÁÚ½Ó±í
    
    ¼´ÁÐÎª15¸ö¶ÓÔ±Ãû×Ö(Ô´Êý¾Ý)£¬ÐÐÎª15¸ö¶ÓÔ±½Óµ½´«Çò¶ÓÔ±µÄÃû×Ö(Ä¿±êÊý¾Ý)£¬¹¹³É15*15µÄ¾ØÕó¡£Í¨¹ý¹¹½¨adjacencyMatrixº¯ÊýÊµÏÖ¡£
    
```{r}
passes$source2 <- as.numeric(as.factor(passes$PLAYER))
passes$target2 <- as.numeric(as.factor(passes$PASS_TO))
adjacencyMatrix<-function(pages){
        n<-max(apply(pages[c("source2","target2")],2,max))
        A <- matrix(0,n,n)
        for(i in 1:nrow(pages)) A[pages[i,]$target2,pages[i,]$source2]<-pages[i,3]
        A
}
A <- adjacencyMatrix(passes)
A
```

###¹¹½¨¸ÅÂÊ¾ØÕó£¨×ªÒÆ¾ØÕó£©
    
    ¿¼ÂÇ×èÄáÏµÍ³µÄÇé¿ö£¬°ÑdÉèÖÃÎª0.85£¬ÔËÓÃÉÏÃæµÄ¹«Ê½£¬×ª»»ÁÚ½Ó±í¾ØÕóÎª¸ÅÂÊ¾ØÕó¡£
    
```{r}
dProbabilityMatrix<-function(G,d=0.85){
        cs <- colSums(G)
        cs[cs==0] <- 1
        n <- nrow(G)
        delta <- (1-d)/n
        A <- matrix(delta,nrow(G),ncol(G))
        for (i in 1:n) A[i,] <- A[i,] + d*G[i,]/cs
        A
}
G <- dProbabilityMatrix(A)
G
```

###µÝ¹é¼ÆËã¾ØÕóÌØÕ÷Öµ
    ¼ÆËã¾ØÕóÌØÕ÷Öµ£¬²¢ÅÅÐòµÃ³ö¶ÓÔ±PagerankÖµÅÅÐò¡£

```{r}
eigenMatrix<-function(G,iter=100){
  iter<-10
  n<-nrow(G)
  x <- rep(1,n)
  for (i in 1:iter) x <- G %*% x
  x/sum(x)
}
q<-eigenMatrix(G,100)
q <- cbind(levels(passes$PLAYER),q)
q <- q[order(q[,2],decreasing = TRUE),]
size <- as.data.frame(q)
names(size) <- c("name","pagerank")
size$pagerank <- as.numeric(as.character(size$pagerank))
size$name <- as.numeric(as.factor(size$name))
q
```

##ÔËÓÃnetworkD3°üÊµÏÖ¿É½»»¥µÄD3ÖÆÍ¼
    
    ÆäÖÐÑÕÉ«·Ö±ð´ú±í¶ÓÔ±²»Í¬Î»ÖÃ(Ç°·æ»òºóÎÀ),È¦È¦´óÐ¡´ú±ípagerankÖµ´óÐ¡£¬Á¬Ïß´ÎÊý(´ÖÏ¸)´ú±í´«ÇòÂ·Ïß¼°´«Çò´ÎÊý¡£
    
```{r}
library(networkD3)
passes$source <- as.numeric(as.factor(passes$PLAYER))-1
passes$target <- as.numeric(as.factor(passes$PASS_TO))-1
passes$PASS <- passes$PASS/50

groups$nodeid <- groups$name
groups$name <- as.numeric(as.factor(groups$name))
groups$group <- as.numeric(as.factor(groups$label))-1
nodes <- merge(groups,size, by.x = "name",by.y = "name")
nodes$pagerank <- nodes$pagerank*1000

forceNetwork(Links = passes,
             Nodes = nodes,
             Source = "source",
             fontFamily = "Arial",
             colourScale = JS("d3.scale.category10()"),
             Target = "target",
             Value = "PASS",
             NodeID = "nodeid",
             Nodesize = "pagerank",
             linkDistance = 350,
             Group = "group", 
             opacity = 0.8,
             fontSize = 16,
             zoom = TRUE,
             opacityNoHover = TRUE)
```


##ËµÃ÷
    
    ±¾ÎÄÊý¾ÝÀ´Ô´ÓÚYUKI KATOHµÄ²©¿Í¼°Æägithub£¬Êý¾Ý½öÓÃÓÚ±¾ÈËÍ¨¹ýRÊµÏÖPageranKËã·¨µÄÑ§Ï°ºÍÑÝÁ·£¬²»ÓÃÓÚÈÎºÎÉÌÒµÐû´«¼°ÆäËûÓÃÍ¾£¬ÈçÓÐ×ªÔØ¼°ÆäËûÓÃÍ¾ÇëÁªÏµÔ­×÷Õß±¾ÈË¡£ÎÄÕÂ×îºó»á¸ø³öÊý¾Ý³ö´¦¼°Á´½Ó<https://github.com/yukiegosapporo/gsw_passing_network>¡£
    
###²Î¿¼ÎÄÕÂ

> YUKI KATOH µÄ²©¿Í <http://opiateforthemass.es/articles/analyzing-golden-state-warriors-passing-network-using-graphframes-in-spark/> ¼°HarryZhu¶ÔÆä ÖÐÎÄ·­Òë<https://segmentfault.com/a/1190000004816528#articleHeader8>

> ÕÅµ¤(Conan) PageRankËã·¨RÓïÑÔÊµÏÖ <http://blog.fens.me/algorithm-pagerank-r/>

> Google µÄÃØÃÜ PageRank ³¹µ×½âËµÖÐÎÄ°æ <http://www.t086.com/good/pagerank_cn.htm>

> SCANÎÄµµËµÃ÷¼°networkD3°üÏà¹ØËµÃ÷

